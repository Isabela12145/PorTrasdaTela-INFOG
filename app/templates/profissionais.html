{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profissionais ‚Äì Por Tr√°s da Tela</title>
    <style>
        :root {
            --bg: #f5f5f5;
            --card: #fff;
            --accent-start: #4169E1;
            --accent-end: #6A5ACD;
            --muted: #6c757d;
            --radius: 14px;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            background: var(--bg);
            color: #111
        }

        .header {
            background: linear-gradient(135deg, var(--accent-start), var(--accent-end));
            padding: 20px;
            border-radius: 0 0 18px 18px;
            text-align: center;
            color: #fff
        }

        .header h2 {
            margin: 0;
            font-weight: 600
        }

        .header p {
            margin: .25rem 0
        }

        .btn-light-like {
            background: #fff;
            color: #222;
            padding: .45rem .6rem;
            border-radius: 10px;
            text-decoration: none;
            display: inline-block;
            margin-top: .5rem;
            font-weight: 600
        }

        .container {
            max-width: 1100px;
            margin: 1.5rem auto;
            padding: 0 1rem
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem
        }

        .col {
            flex: 1 1 calc(33.333% - 1rem);
            min-width: 260px
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: 0 8px 24px rgba(10, 10, 30, .06);
            transition: transform .16s
        }

        .card:hover {
            transform: scale(1.02)
        }

        .profile-row {
            display: flex;
            gap: .75rem;
            align-items: center
        }

        .profile-img {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            background: #eee
        }

        h5 {
            margin: .1rem 0;
            font-size: 1rem
        }

        small.text-muted {
            color: var(--muted)
        }

        hr {
            border: none;
            border-top: 1px solid rgba(0, 0, 0, .06);
            margin: .75rem 0
        }

        p {
            margin: .4rem 0;
            color: #222
        }

        .btn-primary-like {
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
            color: white;
            border: none;
            padding: .5rem .6rem;
            border-radius: 10px;
            cursor: pointer;
            width: 100%
        }

        .list-group {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: .5rem
        }

        .list-group-item {
            background: #fafafa;
            padding: .6rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, .03)
        }

        .list-group-item h6 {
            margin: 0;
            font-size: .98rem
        }

        .excerpt {
            color: var(--muted);
            font-size: .9rem
        }

        .collapse {
            max-height: 0;
            overflow: hidden;
            transition: max-height .28s ease
        }

        .collapse.show {
            max-height: 1000px
        }

        /* modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .45);
            z-index: 1200;
            padding: 1rem
        }

        .modal-backdrop.show {
            display: flex
        }

        .modal-dialog {
            background: #fff;
            border-radius: 12px;
            max-width: 720px;
            width: 100%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, .25);
            overflow: hidden
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between
        }

        .modal-title {
            margin: 0;
            font-size: 1.05rem
        }

        .modal-body {
            padding: 1rem;
            max-height: 60vh;
            overflow: auto;
            color: #111
        }

        .modal-footer {
            padding: .75rem 1rem;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: .5rem
        }

        .btn {
            padding: .45rem .6rem;
            border-radius: 8px;
            border: 0;
            cursor: pointer
        }

        .btn.secondary {
            background: #e9e9ee;
            color: #222
        }

        .btn.primary {
            background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
            color: #fff
        }

        @media (max-width:880px) {
            .col {
                flex: 1 1 calc(50% - 1rem)
            }
        }

        @media (max-width:520px) {
            .col {
                flex: 1 1 100%
            }

            .profile-img {
                width: 56px;
                height: 56px
            }
        }
    </style>
</head>

<body>

    <div class="header">
        <h2>Profissionais Cadastrados</h2>
        <p>Veja os profissionais autorizados a publicar conte√∫dos educativos</p>
        <a class="btn-light-like" href="{% url 'admin:app_conteudoeducativo_add' %}">‚ûï Adicionar Conte√∫do Educativo</a>
    </div>

    <div class="container">
        {% if profissionais %}
        <div class="row">
            {% for p in profissionais %}
            <div class="col">
                <div class="card">
                    <div class="profile-row">
                        <img class="profile-img" src="{{ p.avatar_src }}" alt="Foto de {{ p.nome }}">
                        <div>
                            <h5>{{ p.nome }}</h5>
                            <small class="text-muted">{{ p.especialidade|default:"‚Äî" }}</small>
                        </div>
                    </div>

                    <hr>

                    <p>{{ p.descricao|default:"Sem descri√ß√£o dispon√≠vel." }}</p>

                    <button class="btn-primary-like" type="button" data-toggle-target="#conteudos-{{ p.id }}"
                        aria-expanded="false">
                        üìö Ver Conte√∫dos Publicados
                    </button>

                    <div id="conteudos-{{ p.id }}" class="collapse" aria-hidden="true" style="margin-top:12px;">
                        {% with lista=p.conteudos.all %}
                        {% if lista %}
                        <ul class="list-group">
                            {% for c in lista %}
                            <li class="list-group-item">
                                <div>
                                    <h6>{{ c.titulo }}</h6>
                                    <div class="excerpt">{{ c.excerpt }}</div>

                                    <!-- hidden container with full HTML description (safe-rendered) -->
                                    <div id="content-html-{{ c.id }}" style="display:none;">
                                        {% if c.descricao %}
                                        {{ c.descricao|linebreaksbr }}
                                        {% elif c.texto %}
                                        {{ c.texto|linebreaksbr }}
                                        {% else %}
                                        <div class="text-muted">Descri√ß√£o n√£o dispon√≠vel.</div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- view button: points to the hidden content by id -->
                                <button class="btn primary view-btn" type="button"
                                    data-content-id="content-html-{{ c.id }}" data-title="{{ c.titulo|escape }}">
                                    üîç Visualizar
                                </button>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div style="padding:.6rem;background:#fff3cd;border-radius:8px;border:1px solid #ffeeba">Nenhum
                            conte√∫do publicado por este profissional ainda.</div>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="padding:1rem;background:#fff3cd;border-radius:8px;border:1px solid #ffeeba;text-align:center">Nenhum
            profissional cadastrado ainda.</div>
        {% endif %}
    </div>

    <!-- SINGLE REUSABLE MODAL -->
    <div id="modal-backdrop" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal-dialog" role="document" aria-labelledby="modal-title">
            <div class="modal-header">
                <div id="modal-title" class="modal-title">T√≠tulo</div>
                <button class="btn" id="modal-close-top" aria-label="Fechar">‚úï</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- descri√ß√£o ser√° injetada aqui -->
            </div>
            <div class="modal-footer">
                <button class="btn secondary" id="modal-close">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // Collapse toggles
        document.addEventListener('click', function (e) {
            const t = e.target.closest('[data-toggle-target]');
            if (!t) return;
            const selector = t.getAttribute('data-toggle-target');
            const target = document.querySelector(selector);
            if (!target) return;
            const open = target.classList.contains('show');
            if (open) {
                target.classList.remove('show');
                target.setAttribute('aria-hidden', 'true');
                t.setAttribute('aria-expanded', 'false');
            } else {
                target.classList.add('show');
                target.setAttribute('aria-hidden', 'false');
                t.setAttribute('aria-expanded', 'true');
            }
        });

        // Modal logic (single modal reused)
        (function () {
            const modalBackdrop = document.getElementById('modal-backdrop');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const closeButtons = [document.getElementById('modal-close'), document.getElementById('modal-close-top')];

            // open when clicking .view-btn
            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.view-btn');
                if (!btn) return;
                const contentId = btn.dataset.contentId;
                const title = btn.dataset.title || '';
                const contentEl = document.getElementById(contentId);
                const html = contentEl ? contentEl.innerHTML : '<div class="text-muted">Descri√ß√£o n√£o dispon√≠vel.</div>';

                openModal(title, html, btn);
            });

            // openModal sets content and shows backdrop
            function openModal(title, html, opener) {
                modalTitle.textContent = title;
                modalBody.innerHTML = html;
                modalBackdrop.classList.add('show');
                modalBackdrop.setAttribute('aria-hidden', 'false');

                // save opener for focus restore
                modalBackdrop._opener = opener || document.activeElement;

                // focus close button
                const firstClose = document.getElementById('modal-close-top');
                if (firstClose) firstClose.focus();

                // attach handlers
                document.addEventListener('keydown', onKeyDown);
                modalBackdrop.addEventListener('click', onBackdropClick);
            }

            function closeModal() {
                modalBackdrop.classList.remove('show');
                modalBackdrop.setAttribute('aria-hidden', 'true');
                // restore focus
                if (modalBackdrop._opener && typeof modalBackdrop._opener.focus === 'function') {
                    modalBackdrop._opener.focus();
                }
                // cleanup
                document.removeEventListener('keydown', onKeyDown);
                modalBackdrop.removeEventListener('click', onBackdropClick);
            }

            function onKeyDown(e) {
                if (e.key === 'Escape') closeModal();
            }

            function onBackdropClick(e) {
                // close when clicking outside the dialog (.modal-dialog)
                const dialog = modalBackdrop.querySelector('.modal-dialog');
                if (!dialog) return;
                if (!dialog.contains(e.target)) closeModal();
            }

            // close buttons click
            closeButtons.forEach(btn => {
                if (!btn) return;
                btn.addEventListener('click', closeModal);
            });
        })();
    </script>
</body>

</html>